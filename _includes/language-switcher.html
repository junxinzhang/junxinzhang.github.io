<!-- Language Switcher / 语言切换器 (UI-only i18n) -->
{% assign current_lang = page.lang | default: site.default_lang %}

<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle language-toggle" href="#" id="languageDropdown" role="button"
       data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <span class="current-lang-code" id="currentLangCode">{{ site.data.languages[current_lang].code | default: "EN" }}</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" fill="currentColor" viewBox="0 0 16 16" class="dropdown-arrow"><path d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>
    </a>
    <div class="dropdown-menu dropdown-menu-right language-dropdown" aria-labelledby="languageDropdown">
        {% for lang in site.data.languages %}
        {% assign lang_code = lang[0] %}
        {% assign lang_info = lang[1] %}
        <a class="dropdown-item lang-option" href="#" data-lang="{{ lang_code }}">
            <span class="lang-icon">{{ lang_info.icon }}</span>
            <span class="lang-label">{{ lang_info.label }}</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="ml-2 lang-check" style="display: none;"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg>
        </a>
        {% endfor %}
    </div>
</li>

<style>
.language-toggle {
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 6px 10px !important;
    border-radius: 6px;
    transition: background-color 0.2s;
}
.language-toggle:hover {
    background-color: rgba(255, 255, 255, 0.1);
}
.current-lang-code {
    font-weight: 600;
    font-size: 0.9rem;
    letter-spacing: 0.5px;
}
.dropdown-arrow {
    opacity: 0.7;
}
.language-dropdown {
    max-height: 400px;
    overflow-y: auto;
    min-width: 160px;
}
.language-dropdown .dropdown-item {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
}
.language-dropdown .dropdown-item:hover {
    background-color: #f8f9fa;
}
.language-dropdown .dropdown-item.active {
    background-color: #e9ecef;
    color: #212529;
}
.language-dropdown .lang-icon {
    margin-right: 0.5rem;
    font-size: 1.1em;
}
.language-dropdown .lang-label {
    flex: 1;
}
</style>

<script>
// All translations data embedded from Jekyll
var i18nTranslations = {
{% for lang in site.data.translations %}
    "{{ lang[0] }}": {{ lang[1] | jsonify }}{% unless forloop.last %},{% endunless %}
{% endfor %}
};

// Language labels
var i18nLanguages = {
{% for lang in site.data.languages %}
    "{{ lang[0] }}": {{ lang[1] | jsonify }}{% unless forloop.last %},{% endunless %}
{% endfor %}
};

// Default language from config
var defaultLang = "{{ site.default_lang }}";

// Get nested translation value
function getTranslation(obj, path) {
    var parts = path.split('.');
    var current = obj;
    for (var i = 0; i < parts.length; i++) {
        if (current && current[parts[i]] !== undefined) {
            current = current[parts[i]];
        } else {
            return null;
        }
    }
    return current;
}

// Apply translations to all elements with data-i18n attribute
function applyTranslations(langCode) {
    var translations = i18nTranslations[langCode] || i18nTranslations[defaultLang];
    if (!translations) return;

    // Update elements with data-i18n attribute
    document.querySelectorAll('[data-i18n]').forEach(function(el) {
        var key = el.getAttribute('data-i18n');
        var value = getTranslation(translations, key);
        if (value) {
            if (el.tagName === 'INPUT' && el.hasAttribute('placeholder')) {
                el.placeholder = value;
            } else {
                el.textContent = value;
            }
        }
    });

    // Update elements with data-i18n-title attribute
    document.querySelectorAll('[data-i18n-title]').forEach(function(el) {
        var key = el.getAttribute('data-i18n-title');
        var value = getTranslation(translations, key);
        if (value) {
            el.title = value;
        }
    });

    // Update current language code display
    var langCodeEl = document.getElementById('currentLangCode');
    if (langCodeEl && i18nLanguages[langCode]) {
        langCodeEl.textContent = i18nLanguages[langCode].code || langCode.toUpperCase();
    }

    // Update active state in dropdown
    document.querySelectorAll('.lang-option').forEach(function(el) {
        var itemLang = el.getAttribute('data-lang');
        var checkIcon = el.querySelector('.lang-check');
        if (itemLang === langCode) {
            el.classList.add('active');
            if (checkIcon) checkIcon.style.display = 'inline';
        } else {
            el.classList.remove('active');
            if (checkIcon) checkIcon.style.display = 'none';
        }
    });
}

// Switch language function
function switchLanguage(langCode) {
    localStorage.setItem('preferred_language', langCode);
    applyTranslations(langCode);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Get saved language or use default
    var savedLang = localStorage.getItem('preferred_language') || defaultLang;

    // Apply translations
    applyTranslations(savedLang);

    // Dropdown toggle (replaces Bootstrap dropdown)
    var dropdown = document.getElementById('languageDropdown');
    var dropdownMenu = dropdown ? dropdown.nextElementSibling : null;
    if (dropdown && dropdownMenu) {
        dropdown.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
        });
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdown.contains(e.target) && !dropdownMenu.contains(e.target)) {
                dropdownMenu.classList.remove('show');
            }
        });
    }

    // Add click handlers to language options
    document.querySelectorAll('.lang-option').forEach(function(el) {
        el.addEventListener('click', function(e) {
            e.preventDefault();
            var langCode = this.getAttribute('data-lang');
            switchLanguage(langCode);
            if (dropdownMenu) dropdownMenu.classList.remove('show');
        });
    });
});
</script>
